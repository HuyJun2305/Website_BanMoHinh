@model View.ViewModels.ProductViewModel

@{
    ViewData["Title"] = "Thêm Sản Phẩm";
    Layout = "_LayoutAdmin";
}

<div class="container mt-5">
    <h3 class="mb-4">Thêm sản phẩm</h3>
    <div class="card">
        <div class="card-header bg-primary text-white text-center">
            <h5>Thông Tin Sản Phẩm</h5>
        </div>
        <div class="card-body">
            <form id="productForm" enctype="multipart/form-data" method="post">
                <div class="row">
                    <!-- Product Name -->
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label asp-for="Name" class="form-label">Tên Sản Phẩm <span class="text-danger">*</span></label>
                            <input asp-for="Name" class="form-control" placeholder="Nhập tên sản phẩm" required />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Price -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="Price" class="form-label">Giá <span class="text-danger">*</span></label>
                            <input asp-for="Price" class="form-control" placeholder="Nhập giá sản phẩm" required />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Stock -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="Stock" class="form-label">Số lượng <span class="text-danger">*</span></label>
                            <input asp-for="Stock" class="form-control" placeholder="Nhập số lượng sản phẩm" required />
                            <span asp-validation-for="Stock" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="CategoryId" class="form-label">Danh mục  <span class="text-danger">*</span></label>
                            <select asp-for="CategoryId" class="form-control" required>
                                <option value="">Chọn thương hiệu</option>
                                @foreach (var brand in (IEnumerable<SelectListItem>)ViewData["BrandId"])
                                {
                                    <option value="@brand.Value">@brand.Text</option>
                                }
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Brand -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="BrandId" class="form-label">Thương hiệu <span class="text-danger">*</span></label>
                            <select asp-for="BrandId" class="form-control" required>
                                <option value="">Chọn thương hiệu</option>
                                @foreach (var brand in (IEnumerable<SelectListItem>)ViewData["BrandId"])
                                {
                                    <option value="@brand.Value">@brand.Text</option>
                                }
                            </select>
                            <span asp-validation-for="BrandId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="MaterialId" class="form-label">Chất Liệu <span class="text-danger">*</span></label>
                            <select asp-for="MaterialId" class="form-control" required>
                                <option value="">Chọn chất liệu</option>
                                @foreach (var material in (IEnumerable<SelectListItem>)ViewData["MaterialId"])
                                {
                                    <option value="@material.Value">@material.Text</option>
                                }
                            </select>
                            <span asp-validation-for="MaterialId" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Size -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="SizeId" class="form-label">Kích thước <span class="text-danger">*</span></label>
                            <div class="d-flex gap-2">
                                <select asp-for="SizeId" class="form-control" required>
                                    <option value="">------</option>
                                    @foreach (var size in (IEnumerable<SelectListItem>)ViewData["SizeId"])
                                    {
                                        <option value="@size.Value">@size.Text</option>
                                    }
                                </select>
                            </div>
                            <span asp-validation-for="SizeId" class="text-danger"></span>
                        </div>
                    </div>


                    <!-- File Upload -->
                      <div class="col-md-12 mb-3">
                        <label for="files" class="form-label">Thêm Ảnh Sản Phẩm</label>
                        <input type="button" id="files" class="btn btn-primary" value="Chọn Ảnh" />
                      </div>

                    <div id="selectedImages" class="row mt-3">
                             <!-- Ảnh được chọn sẽ hiển thị tại đây -->
                    </div> 


                    <!-- Description -->
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label asp-for="Description" class="form-label">Mô Tả Sản Phẩm</label>
                            <textarea asp-for="Description" class="form-control" rows="3" placeholder="Nhập mô tả sản phẩm"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                    </div>

                    

                    <!-- Submit Button -->
                    <div class="col-md-12 text-center">
                        <button type="submit" class="btn btn-primary">Tạo Sản Phẩm</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Hiển Thị Ảnh -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Chọn Ảnh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="imageGallery">
                    <!-- Hình ảnh sẽ được load tại đây -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmImages">Xác nhận</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>




@section Scripts {
    <script>
        document.getElementById('files').addEventListener('click', async function () {
    const imageGallery = document.getElementById('imageGallery');
    imageGallery.innerHTML = ''; // Clear gallery

    try {
        // Fetch images from the server
        const response = await fetch('/Products/GetImages');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                data.images.forEach(image => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';
                    col.innerHTML = `
                        <div class="card">
                            <img src="${image.url}" class="card-img-top" alt="Image" data-image-id="${image.id}">
                            <div class="card-body text-center">
                                <input type="checkbox" class="form-check-input select-image" data-image-id="${image.id}">
                            </div>
                        </div>`;
                    imageGallery.appendChild(col);
                });
            } else {
                alert('Không có ảnh nào để hiển thị.');
            }
        } else {
            alert('Lỗi khi tải ảnh.');
        }
    } catch (error) {
        console.error('Lỗi:', error);
        alert('Đã xảy ra lỗi khi tải ảnh.');
    }

    // Hiển thị modal
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
});

// Lưu ảnh đã chọn
document.getElementById('confirmImages').addEventListener('click', function () {
    const selectedImages = Array.from(document.querySelectorAll('.select-image:checked')).map(checkbox => checkbox.dataset.imageId);

    if (selectedImages.length === 0) {
        alert('Vui lòng chọn ít nhất một ảnh.');
        return;
    }

    // Hiển thị ảnh đã chọn ở phía ngoài modal
    const selectedImageContainer = document.getElementById('selectedImages');
    selectedImageContainer.innerHTML = '';
    selectedImages.forEach(imageId => {
        const imgElement = document.querySelector(`img[data-image-id="${imageId}"]`);
        if (imgElement) {
            const imgCopy = imgElement.cloneNode();
            imgCopy.classList.add('selected-image', 'col-md-3', 'mb-3');
            selectedImageContainer.appendChild(imgCopy);
        }
    });

    // Đóng modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
    modal.hide();
});

// Submit form xử lý sản phẩm và ảnh đã chọn
document.getElementById('productForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const selectedImages = Array.from(document.querySelectorAll('.select-image:checked')).map(checkbox => checkbox.dataset.imageId);

    if (selectedImages.length === 0) {
        alert('Vui lòng chọn ít nhất một ảnh.');
        return;
    }

    formData.append('selectedImages', JSON.stringify(selectedImages));

    try {
        const response = await fetch('/Products/Create', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                alert('Sản phẩm đã được tạo thành công!');
                window.location.reload();
            } else {
                alert(data.message || 'Đã xảy ra lỗi khi tạo sản phẩm.');
            }
        } else {
            alert('Lỗi mạng khi tạo sản phẩm.');
        }
    } catch (error) {
        console.error('Lỗi:', error);
        alert('Đã xảy ra lỗi.');
    }
});

    </script>
}
