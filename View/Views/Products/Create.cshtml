@model View.ViewModels.ProductViewModel

@{
    ViewData["Title"] = "Thêm Sản Phẩm";
    Layout = "_LayoutAdmin";
}

<div class="container mt-5">
    <h3 class="mb-4">Thêm sản phẩm</h3>
    <div class="card">
        <div class="card-header bg-primary text-white text-center">
            <h5>Thông Tin Sản Phẩm</h5>
        </div>
        <div class="card-body">
            <form id="productForm" enctype="multipart/form-data" method="post">
                <div class="row">
                    <!-- Product Name -->
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label asp-for="Name" class="form-label">Tên Sản Phẩm <span class="text-danger">*</span></label>
                            <input asp-for="Name" class="form-control" placeholder="Nhập tên sản phẩm" required />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Price -->
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label asp-for="Price" class="form-label">Giá <span class="text-danger">*</span></label>
                            <input asp-for="Price" class="form-control" placeholder="Nhập giá sản phẩm" required />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Price -->
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label asp-for="Stock" class="form-label">Số lượng <span class="text-danger">*</span></label>
                            <input asp-for="Stock" class="form-control" placeholder="Nhập số lượng sản phẩm" required />
                            <span asp-validation-for="Stock" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Brand -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="BrandId" class="form-label">Thương Hiệu <span class="text-danger">*</span></label>
                            <select asp-for="BrandId" class="form-control" required>
                                <option value="">Chọn thương hiệu</option>
                                @foreach (var brand in (IEnumerable<SelectListItem>)ViewData["BrandId"])
                                {
                                    <option value="@brand.Value">@brand.Text</option>
                                }
                            </select>
                            <span asp-validation-for="BrandId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="MaterialId" class="form-label">Chất Liệu <span class="text-danger">*</span></label>
                            <select asp-for="MaterialId" class="form-control" required>
                                <option value="">Chọn chất liệu</option>
                                @foreach (var material in (IEnumerable<SelectListItem>)ViewData["MaterialId"])
                                {
                                    <option value="@material.Value">@material.Text</option>
                                }
                            </select>
                            <span asp-validation-for="MaterialId" class="text-danger"></span>
                        </div>
                    </div>
                    <!-- Size -->
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label asp-for="SizeId" class="form-label">Kích thước <span class="text-danger">*</span></label>
                            <div class="d-flex gap-2">
                                <select asp-for="SizeId" class="form-control" required>
                                    <option value="">------</option>
                                    @foreach (var size in (IEnumerable<SelectListItem>)ViewData["SizeId"])
                                    {
                                        <option value="@size.Value">@size.Text</option>
                                    }
                                </select>
                            </div>
                            <span asp-validation-for="SizeId" class="text-danger"></span>
                        </div>
                    </div>


                    <!-- File Upload -->
                    <div class="col-md-12 mb-3">
                        <label for="files" class="form-label">Thêm Ảnh Sản Phẩm <span class="text-danger">*</span></label>
                        <input type="file" name="files" id="files" multiple class="form-control" required />
                    </div>


                    <!-- Description -->
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <label asp-for="Description" class="form-label">Mô Tả Sản Phẩm</label>
                            <textarea asp-for="Description" class="form-control" rows="3" placeholder="Nhập mô tả sản phẩm"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>
                    </div>

                    

                    <!-- Submit Button -->
                    <div class="col-md-12 text-center">
                        <button type="submit" class="btn btn-primary">Tạo Sản Phẩm</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('productForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            let form = e.target;
            let formData = new FormData(form);

            // Kiểm tra xem có ảnh nào được chọn hay không
            let imageFiles = document.getElementById('files').files;
            if (imageFiles.length === 0) {
                alert('Vui lòng chọn ít nhất một ảnh.');
                return; // Dừng xử lý nếu không có ảnh
            }

            try {
                // Tạo sản phẩm
                let productResponse = await fetch('/Products/Create', {
                    method: 'POST',
                    body: formData,
                });

                if (productResponse.ok) {
                    let productData = await productResponse.json();
                    if (productData.success) {
                        alert('Tạo sản phẩm thành công!');

                        let productId = productData.productId;

                        // Tải ảnh
                        for (let file of imageFiles) {
                            let imageFormData = new FormData();
                            imageFormData.append('imageFile', file);
                            imageFormData.append('productId', productId);

                            let uploadResponse = await fetch('/Products/Upload', {
                                method: 'POST',
                                body: imageFormData,
                            });

                            if (uploadResponse.ok) {
                                let uploadData = await uploadResponse.json();
                                if (!uploadData.success) {
                                    alert(`Lỗi tải ảnh: ${uploadData.message}`);
                                }
                            } else {
                                alert('Lỗi mạng khi tải ảnh.');
                            }
                        }
                        window.location.reload(); // Tải lại trang hoặc điều hướng
                    } else {
                        alert(productData.message || 'Lỗi tạo sản phẩm.');
                    }
                } else {
                    alert('Lỗi mạng khi tạo sản phẩm.');
                }
            } catch (error) {
                console.error('Lỗi:', error);
                alert('Đã xảy ra lỗi trong quá trình xử lý.');
            }
        });
    </script>
}
